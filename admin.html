<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Gestion des données</title>
  <link rel="icon" href="assets/img/cargo.png" type="image/png">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    body {background: linear-gradient(135deg,#e0eafc 0%,#cfdef3 100%);}
    .admin-container {max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); padding: 32px 28px;}
    .table-actions button {margin-right: 4px;}
  </style>
</head>
<body>
  <div class="admin-container">
    <h2 class="mb-4">Tableau d'administration des données</h2>
    <h3 class="mb-4">Ajouter un navire</h3>
    <form id="addForm" class="mb-4">
      <div class="form-row">
        <div class="form-group col-md-2"><input name="MMSI" class="form-control" placeholder="MMSI" required></div>
        <div class="form-group col-md-2"><input name="IMO" class="form-control" placeholder="IMO"></div>
        <div class="form-group col-md-2"><input name="CallSign" class="form-control" placeholder="CallSign"></div>
        <div class="form-group col-md-2"><input name="VesselName" class="form-control" placeholder="Nom"></div>
        <div class="form-group col-md-1"><input name="VesselType" class="form-control" placeholder="Type"></div>
        <div class="form-group col-md-1"><input name="Length" class="form-control" placeholder="Longueur"></div>
        <div class="form-group col-md-1"><input name="Width" class="form-control" placeholder="Largeur"></div>
        <div class="form-group col-md-1"><input name="Draft" class="form-control" placeholder="Draft"></div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-3"><input name="Cargo" class="form-control" placeholder="Cargo"></div>
        <div class="form-group col-md-3"><input name="TransceiverClass" class="form-control" placeholder="Classe"></div>
        <div class="form-group col-md-3"><button type="submit" class="btn btn-success btn-block">Ajouter</button></div>
      </div>
    </form>
    <h3 class="mb-3">Liste des navires</h3>
    <div class="form-group position-relative" style="max-width:400px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par MMSI ou nom..." autocomplete="off">
      <div id="searchSuggestions" class="list-group position-absolute w-100" style="z-index:1000"></div>
    </div>
    <!-- Modal édition bateau -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Modifier le navire</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="editForm">
            <div class="modal-body">
              <input type="hidden" id="edit-MMSI" name="MMSI">
              <div class="form-group"><label>MMSI</label><input id="edit-MMSI-view" class="form-control" disabled></div>
              <div class="form-group"><label>IMO</label><input id="edit-IMO" name="IMO" class="form-control"></div>
              <div class="form-group"><label>CallSign</label><input id="edit-CallSign" name="CallSign" class="form-control"></div>
              <div class="form-group"><label>Nom</label><input id="edit-VesselName" name="VesselName" class="form-control"></div>
              <div class="form-group"><label>Type</label><input id="edit-VesselType" name="VesselType" class="form-control"></div>
              <div class="form-group"><label>Longueur</label><input id="edit-Length" name="Length" class="form-control"></div>
              <div class="form-group"><label>Largeur</label><input id="edit-Width" name="Width" class="form-control"></div>
              <div class="form-group"><label>Draft</label><input id="edit-Draft" name="Draft" class="form-control"></div>
              <div class="form-group"><label>Cargo</label><input id="edit-Cargo" name="Cargo" class="form-control"></div>
              <div class="form-group"><label>Classe</label><input id="edit-TransceiverClass" name="TransceiverClass" class="form-control"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-success">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <table class="table table-bordered table-hover" id="table-bateaux">
      <thead class="thead-dark">
        <tr>
          <th>MMSI</th>
          <th>IMO</th>
          <th>CallSign</th>
          <th>Nom</th>
          <th>Type</th>
          <th>Longueur</th>
          <th>Largeur</th>
          <th>Draft</th>
          <th>Cargo</th>
          <th>Classe</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <nav>
      <ul id="pagination" class="pagination pagination-sm"></ul>
    </nav>
    <a href="index.html" class="btn btn-secondary ml-2">Retour à l'accueil</a>
  </div>
  <script>
    let allBateaux = [];
    let filteredBateaux = [];

    async function chargerBateaux() {
      const res = await fetch('api/boats.php');
      allBateaux = await res.json();
      filteredBateaux = allBateaux;
      afficherBateaux();
    }

    let currentPage = 1;
    const rowsPerPage = 10;

    function afficherBateaux() {
      const total = filteredBateaux.length;
      const start = (currentPage-1)*rowsPerPage;
      const end = start + rowsPerPage;
      let html = '';
      filteredBateaux.slice(start, end).forEach(b => {
        html += `<tr>
          <td>${b.MMSI}</td>
          <td>${b.IMO||''}</td>
          <td>${b.CallSign||''}</td>
          <td>${b.VesselName||''}</td>
          <td>${b.VesselType||''}</td>
          <td>${b.Length||''}</td>
          <td>${b.Width||''}</td>
          <td>${b.Draft||''}</td>
          <td>${b.Cargo||''}</td>
          <td>${b.TransceiverClass||''}</td>
          <td>
            <button class='btn btn-sm btn-warning' onclick='editBateau(${b.MMSI})'>Modifier</button>
            <button class='btn btn-sm btn-danger' onclick='deleteBateau(${b.MMSI})'>Supprimer</button>
          </td>
        </tr>`;
      });
      document.querySelector('#table-bateaux tbody').innerHTML = html;
      afficherPagination();
    }
    function afficherPagination() {
      const totalPages = Math.ceil(filteredBateaux.length/rowsPerPage) || 1;
      let html = '';
      for (let i=1; i<=totalPages; i++) {
        html += `<li class="page-item${i===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${i});return false;">${i}</a></li>`;
      }
      document.getElementById('pagination').innerHTML = html;
    }
    window.gotoPage = function(page) {
      currentPage = page;
      afficherBateaux();
      document.body.scrollTop = document.documentElement.scrollTop = 0;
    }
    chargerBateaux();

    // Barre de recherche et suggestions
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    searchInput.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      if (!q) {
        filteredBateaux = allBateaux;
        afficherBateaux();
        searchSuggestions.innerHTML = '';
        return;
      }
      filteredBateaux = allBateaux.filter(b =>
        (b.MMSI && b.MMSI.toString().includes(q)) ||
        (b.VesselName && b.VesselName.toLowerCase().includes(q))
      );
      afficherBateaux();
      // Suggestions auto-complétion
      let suggestions = filteredBateaux.slice(0, 6).map(b =>
        `<button type='button' class='list-group-item list-group-item-action' data-mmsi='${b.MMSI}'>${b.MMSI} - ${b.VesselName||''}</button>`
      ).join('');
      searchSuggestions.innerHTML = suggestions;
    });
    searchSuggestions.addEventListener('mousedown', function(e) {
      if (e.target && e.target.matches('button[data-mmsi]')) {
        const mmsi = e.target.getAttribute('data-mmsi');
        const bateau = allBateaux.find(b => b.MMSI == mmsi);
        if (bateau) {
          searchInput.value = bateau.MMSI + (bateau.VesselName ? ' - ' + bateau.VesselName : '');
          filteredBateaux = [bateau];
          afficherBateaux();
          searchSuggestions.innerHTML = '';
        }
      }
    });
    document.addEventListener('click', function(e) {
      if (!searchSuggestions.contains(e.target) && e.target !== searchInput) {
        searchSuggestions.innerHTML = '';
      }
    });

    document.getElementById('addForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const data = {};
      for (let el of form.elements) if (el.name) data[el.name] = el.value;
      const res = await fetch('api/boats.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      form.reset();
      chargerBateaux();
    };

    window.deleteBateau = async function(mmsi) {
      console.log('[deleteBateau] MMSI envoyé:', mmsi);
      if (!mmsi || mmsi === '' || mmsi === null || mmsi === undefined) {
        alert('Erreur : MMSI invalide, impossible de supprimer ce navire.');
        return;
      }
      if (!confirm('Supprimer ce navire ?')) return;
      try {
        const res = await fetch('api/boats.php', {
          method: 'DELETE',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({MMSI: mmsi})
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          alert('Erreur lors de la suppression : ' + (json.error || 'Erreur inconnue'));
          console.error('[deleteBateau] Erreur serveur:', json);
        } else {
          chargerBateaux();
        }
      } catch (e) {
        alert('Erreur réseau lors de la suppression.');
        console.error('[deleteBateau] Exception fetch:', e);
      }
    };

    window.editBateau = function(mmsi) {
      const bateau = allBateaux.find(b => b.MMSI == mmsi);
      if (!bateau) return;
      document.getElementById('edit-MMSI').value = bateau.MMSI;
      document.getElementById('edit-MMSI-view').value = bateau.MMSI;
      document.getElementById('edit-IMO').value = bateau.IMO||'';
      document.getElementById('edit-CallSign').value = bateau.CallSign||'';
      document.getElementById('edit-VesselName').value = bateau.VesselName||'';
      document.getElementById('edit-VesselType').value = bateau.VesselType||'';
      document.getElementById('edit-Length').value = bateau.Length||'';
      document.getElementById('edit-Width').value = bateau.Width||'';
      document.getElementById('edit-Draft').value = bateau.Draft||'';
      document.getElementById('edit-Cargo').value = bateau.Cargo||'';
      document.getElementById('edit-TransceiverClass').value = bateau.TransceiverClass||'';
      $('#editModal').modal('show');
    };

    document.getElementById('editForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = {
        MMSI: document.getElementById('edit-MMSI').value,
        IMO: document.getElementById('edit-IMO').value,
        CallSign: document.getElementById('edit-CallSign').value,
        VesselName: document.getElementById('edit-VesselName').value,
        VesselType: document.getElementById('edit-VesselType').value,
        Length: document.getElementById('edit-Length').value,
        Width: document.getElementById('edit-Width').value,
        Draft: document.getElementById('edit-Draft').value,
        Cargo: document.getElementById('edit-Cargo').value,
        TransceiverClass: document.getElementById('edit-TransceiverClass').value
      };
      await fetch('api/boats.php', {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      $('#editModal').modal('hide');
      chargerBateaux();
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
