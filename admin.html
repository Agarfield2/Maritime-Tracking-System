<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Gestion des données</title>
  <script>
    // Le contrôle d'accès est géré côté serveur
    document.addEventListener('DOMContentLoaded', function() {
      // Initialisation de la page admin
      console.log('Page admin chargée');
    });
  </script>
  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="icon" href="assets/img/cargo.png" type="image/png">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/auth.css" />
  <style>
    body {background: linear-gradient(135deg,#e0eafc 0%,#cfdef3 100%);}
    .admin-container {max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); padding: 32px 28px;}
    .table-actions button {margin-right: 4px;}
  </style>
  
  

  

  

  

  <link rel="stylesheet" href="assets/css/common.css">
</head>
<body>

  <!-- Template Header -->
  <div id="template-header">
    <!-- Le contenu du header sera chargé dynamiquement -->
  </div>


  <!-- Template Header -->
  <div id="template-header">
    <!-- Le contenu du header sera chargé dynamiquement -->
  </div>

  
  <div class="admin-container">
    <h2 class="mb-4">Tableau d'administration des données</h2>
    <h3 class="mb-4">Ajouter un navire</h3>
    <form id="addForm" class="mb-4" novalidate>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>MMSI <span class="text-danger">*</span></label>
          <input name="MMSI" class="form-control" placeholder="123456789" required 
                 pattern="\d{9}" title="Le MMSI doit contenir exactement 9 chiffres">
          <small class="form-text text-muted">9 chiffres requis</small>
        </div>
        <div class="form-group col-md-4">
          <label>IMO <span class="text-danger">*</span></label>
          <input name="IMO" class="form-control" placeholder="9876543" required
                 pattern="\d{7}" title="Le numéro IMO doit contenir 7 chiffres">
          <small class="form-text text-muted">7 chiffres requis</small>
        </div>
        <div class="form-group col-md-4">
          <label>CallSign <span class="text-danger">*</span></label>
          <input name="CallSign" class="form-control" placeholder="FXYZ" required
                 pattern="[A-Z0-9]{3,7}" title="3 à 7 caractères alphanumériques en majuscules">
          <small class="form-text text-muted">3 à 7 caractères alphanumériques</small>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>Nom <span class="text-danger">*</span></label>
          <input name="VesselName" class="form-control" placeholder="Nom du navire" required
                 pattern=".{3,100}" title="Entre 3 et 100 caractères">
          <small class="form-text text-muted">3 à 100 caractères</small>
        </div>
        <div class="form-group col-md-2">
          <label>Type de navire <span class="text-danger">*</span></label>
          <input list="vesselTypes" name="VesselType" class="form-control" 
                 placeholder="Code IMO" required
                 pattern="\d{1,3}" 
                 title="Code numérique IMO (ex: 30, 35, 80, etc.)">
          <datalist id="vesselTypes">
            <option value="60">60 - Navire à passagers</option>
            <option value="70">70 - Cargo</option>
            <option value="80">80 - Pétrolier</option>
          </datalist>
          <small class="form-text text-muted">Code IMO (ex: 30, 35, 80...)</small>
        </div>
        <div class="form-group col-md-2">
          <label>Longueur (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" name="Length" class="form-control" placeholder="300" required
                 min="1" max="1000" title="Entre 1 et 1000 mètres">
          <small class="form-text text-muted">1 à 1000 mètres</small>
        </div>
        <div class="form-group col-md-2">
          <label>Largeur (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" name="Width" class="form-control" placeholder="48" required
                 min="1" max="200" title="Entre 1 et 200 mètres">
          <small class="form-text text-muted">1 à 200 mètres</small>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-3">
          <label>Tirant d'eau (m)</label>
          <input type="number" step="0.1" name="Draft" class="form-control" placeholder="12.5"
                 min="0.1" max="100" title="Entre 0.1 et 100 mètres">
          <small class="form-text text-muted">0.1 à 100 mètres</small>
        </div>
        <div class="form-group col-md-3">
          <label>Cargaison</label>
          <input name="Cargo" class="form-control" placeholder="Type de cargaison"
                 pattern=".{0,50}" title="Jusqu'à 50 caractères">
        </div>
        <div class="form-group col-md-3">
          <label>Classe d'émetteur</label>
          <select name="TransceiverClass" class="form-control">
            <option value="A">A - Classe A</option>
            <option value="B" selected>B - Classe B</option>
            <option value="SOTDMA">SOTDMA</option>
            <option value="CS">CS - Carrier Sense</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-12">
          <button type="submit" class="btn btn-success">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Ajouter le navire
          </button>
        </div>
      </div>
      <div id="addShipMessage" class="mt-3"></div>
    </form>
    <h3 class="mb-3">Liste des navires</h3>
    <div class="form-group position-relative" style="max-width:400px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par MMSI ou nom..." autocomplete="off">
      <div id="searchSuggestions" class="list-group position-absolute w-100" style="z-index:1000"></div>
    </div>
    <!-- Modal édition bateau -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Modifier le navire</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="editForm">
            <div class="modal-body">
              <input type="hidden" id="edit-MMSI" name="MMSI">
              <div class="form-group"><label>MMSI</label><input id="edit-MMSI-view" class="form-control" disabled></div>
              <div class="form-group"><label>IMO</label><input id="edit-IMO" name="IMO" class="form-control"></div>
              <div class="form-group"><label>CallSign</label><input id="edit-CallSign" name="CallSign" class="form-control"></div>
              <div class="form-group"><label>Nom</label><input id="edit-VesselName" name="VesselName" class="form-control"></div>
              <div class="form-group"><label>Type</label><input id="edit-VesselType" name="VesselType" class="form-control"></div>
              <div class="form-group"><label>Longueur</label><input id="edit-Length" name="Length" class="form-control"></div>
              <div class="form-group"><label>Largeur</label><input id="edit-Width" name="Width" class="form-control"></div>
              <div class="form-group"><label>Draft</label><input id="edit-Draft" name="Draft" class="form-control"></div>
              <div class="form-group"><label>Cargo</label><input id="edit-Cargo" name="Cargo" class="form-control"></div>
              <div class="form-group"><label>Classe</label><input id="edit-TransceiverClass" name="TransceiverClass" class="form-control"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-success">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <table class="table table-bordered table-hover" id="table-bateaux">
      <thead class="thead-dark">
        <tr>
          <th>MMSI</th>
          <th>IMO</th>
          <th>CallSign</th>
          <th>Nom</th>
          <th>Type</th>
          <th>Longueur</th>
          <th>Largeur</th>
          <th>Draft</th>
          <th>Cargo</th>
          <th>Classe</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <a href="index.html" class="btn btn-secondary ml-2">Retour à l'accueil</a>
  </div>
  <!-- Scripts JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  
  <!-- Script d'authentification -->
  
  
  <!-- Scripts spécifiques à la page admin -->
  <script src="assets/js/admin.js"></script>
  <script src="assets/js/clusters.js"></script>
  <script>
    // Initialisation spécifique à la page admin
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier si l'utilisateur est connecté
      checkAuth().then(user => {
        if (user) {
          // Mettre à jour le titre de la page
          document.title = 'Tableau de bord - ' + user.username;
          
          // Initialiser les tooltips Bootstrap
          $('[data-toggle="tooltip"]').tooltip();
          
          // Initialiser les autres fonctionnalités spécifiques à la page admin
          initializeAdminFeatures();
        }
      });
    });
    
    // Fonction d'initialisation des fonctionnalités spécifiques à la page admin
    function initializeAdminFeatures() {
      // Initialiser les fonctionnalités spécifiques à admin.html ici
      console.log('Fonctionnalités admin initialisées');
      
      // Surcharger la fonction updateUIForAuthenticatedUser pour personnaliser le logo
      const originalUpdateUI = window.updateUIForAuthenticatedUser;
      window.updateUIForAuthenticatedUser = function(user) {
        // Appeler l'implémentation originale
        originalUpdateUI(user);
        
        // Personnalisation supplémentaire pour la page admin
        const logoLink = document.querySelector('.navbar-brand');
        if (logoLink) {
          logoLink.innerHTML = `
            <img src="assets/img/cargo.png" alt="Logo AIS" style="height:40px;width:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);background:#fff;padding:2px;">
            <span style="font-weight:bold;letter-spacing:1px;color:#28a745;">AIS&nbsp;Admin</span>`;
        }
      };
    }

  // Gestion de la validation en temps réel pour le formulaire d'ajout
  document.addEventListener('DOMContentLoaded', async function() {
    // Vérifier l'authentification
    await checkAuth();
    
    // Initialisation des tooltips Bootstrap
    $('[data-toggle="tooltip"]').tooltip();
    
    // Validation en temps réel
    const inputs = document.querySelectorAll('#addForm [required]');
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        if (this.checkValidity()) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        }
      });
    });

    // Gestion de la soumission du formulaire
    const addForm = document.getElementById('addForm');
    if (addForm) {
      addForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Vérification de la validité du formulaire
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        // Désactiver le bouton pendant l'envoi
        const submitBtn = this.querySelector('button[type="submit"]');
        const spinner = submitBtn.querySelector('.spinner-border');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        submitBtn.innerHTML = 'Traitement en cours...';
        
        try {
          const formData = new FormData(this);
          const data = Object.fromEntries(formData.entries());
          
          const response = await fetch('api/boats.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Navire ajouté avec succès !');
            this.reset();
            this.classList.remove('was-validated');
            // Réinitialiser les états de validation
            const validatedInputs = this.querySelectorAll('.is-valid, .is-invalid');
            validatedInputs.forEach(input => {
              input.classList.remove('is-valid', 'is-invalid');
            });
            // Recharger la liste des navires si la fonction existe
            if (typeof loadShips === 'function') {
              loadShips();
            }
          } else {
            throw new Error(result.error || 'Erreur lors de l\'ajout du navire');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur: ' + (error.message || 'Une erreur est survenue'));
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          spinner.classList.add('d-none');
        }
      });
    }
  });
  </script>
  <script src="assets/js/admin.js"></script>
  <script>
    // Gestionnaire d'erreur pour les requêtes AJAX non authentifiées
    $(document).ajaxError(function(event, jqXHR) {
      if (jqXHR.status === 401) {
        // Non autorisé - rediriger vers la page de connexion
        window.location.href = 'login.html?session_expired=1';
      }
    });
  </script>


  <!-- Template Footer -->
  <div id="template-footer">
    <!-- Le contenu du footer sera chargé dynamiquement -->
  </div>



  <!-- Scripts communs -->
  
  
  



  <!-- Template Footer -->
  <div id="template-footer">
    <!-- Le contenu du footer sera chargé dynamiquement -->
  </div>



  <!-- Scripts communs -->
  
  
  



  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/loadTemplates.js"></script>
  <script src="assets/js/auth.js"></script>
</body>
</html>
