<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Gestion des données</title>
  <script>
    // Le contrôle d'accès est géré côté serveur
    document.addEventListener('DOMContentLoaded', function() {
      // Initialisation de la page admin
      console.log('Page admin chargée');
    });
  </script>
  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="icon" href="assets/img/cargo.png" type="image/png">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/auth.css" />
  <style>
    body {background: linear-gradient(135deg,#e0eafc 0%,#cfdef3 100%);}
    .admin-container {max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); padding: 32px 28px;}
    .table-actions button {margin-right: 4px;}
  </style>
  
  

  

  

  

  

  

  

  

  <link rel="stylesheet" href="assets/css/common.css">
</head>
<body>

  <!-- Template Header -->
  <div id="template-header">
    <!-- Le contenu du header sera chargé dynamiquement -->
  </div>


  <!-- Template Header -->
  <div id="template-header">
    <!-- Le contenu du header sera chargé dynamiquement -->
  </div>

  
  <div class="admin-container">
    <h2 class="mb-4">Tableau d'administration des données</h2>
    <h3 class="mb-4">Ajouter un navire</h3>
    <form id="shipForm" class="mb-4">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>MMSI <span class="text-danger">*</span></label>
          <input name="MMSI" class="form-control" placeholder="123456789" required 
                pattern="\d{9}" title="Le MMSI doit contenir exactement 9 chiffres">
          <small class="form-text text-muted">9 chiffres requis</small>
        </div>
        <div class="form-group col-md-4">
          <label>IMO <span class="text-danger">*</span></label>
          <input name="IMO" class="form-control" placeholder="IMO9060247" required
                pattern="IMO\d{7}" title="Le numéro IMO doit commencer par 'IMO' suivi de 7 chiffres">
          <small class="form-text text-muted">Format requis : IMO1234567</small>
        </div>
        <div class="form-group col-md-4">
          <label>CallSign <span class="text-danger">*</span></label>
          <input name="CallSign" class="form-control" placeholder="FXYZ" required
                pattern="[A-Z0-9]{3,7}" title="3 à 7 caractères alphanumériques en majuscules">
          <small class="form-text text-muted">3 à 7 caractères alphanumériques</small>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>Nom <span class="text-danger">*</span></label>
          <input name="VesselName" class="form-control" placeholder="Nom du navire" required
                pattern=".{3,100}" title="Entre 3 et 100 caractères">
          <small class="form-text text-muted">3 à 100 caractères</small>
        </div>
        <div class="form-group col-md-2">
          <label>Type de navire <span class="text-danger">*</span></label>
          <input list="vesselTypes" name="VesselType" class="form-control" 
                placeholder="Code type (ex : 70)" required
                pattern="\d{1,3}" 
                title="Code numérique du type de navire (ex : 60, 70, 80)">
          <datalist id="vesselTypes">
            <!-- Catégories principales -->
            <option value="60">60 - Navire à passagers</option>
            <option value="70">70 - Cargo</option>
            <option value="80">80 - Pétrolier</option>
          </datalist>
          <small class="form-text text-muted">Code numérique du type de navire (ex: 60, 70, 80)</small>
        </div>
        <div class="form-group col-md-2">
          <label>Longueur (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" name="Length" class="form-control" placeholder="300" required
                min="1" max="1000" title="Entre 1 et 1000 mètres">
          <small class="form-text text-muted">1 à 1000 mètres</small>
        </div>
        <div class="form-group col-md-2">
          <label>Largeur (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" name="Width" class="form-control" placeholder="48" required
                min="1" max="200" title="Entre 1 et 200 mètres">
          <small class="form-text text-muted">1 à 200 mètres</small>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-2">
          <label>Tirant d'eau (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" name="Draft" class="form-control" placeholder="12.5" required
                min="0.1" max="100" title="Entre 0.1 et 100 mètres">
          <small class="form-text text-muted">0.1 à 100 mètres</small>
        </div>
        <div class="form-group col-md-4">
          <label>Type de cargaison <span class="text-danger">*</span></label>
          <input name="Cargo" class="form-control" placeholder="Ex: 81, 79, 0, 10" required>
          <small class="form-text text-muted">Nombre entier de 0 à 200 (ex: 81, 79, 0, 10)</small>
        </div>
        <div class="form-group col-md-3">
          <label>Classe d'émetteur <span class="text-danger">*</span></label>
          <select name="TransceiverClass" class="form-control" style="min-width: 100%; line-height: 1.5; padding: 0.5rem 0.75rem;" required>
            <option value="">Sélectionnez...</option>
            <option value="A">A - Professionnel</option>
            <option value="B">B - Loisir</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Enregistrer</button>
      <button type="reset" class="btn btn-outline-secondary ml-2" onclick="resetFormValidation(this.form)">Réinitialiser</button>
    </form>
    <div id="addShipMessage" class="mt-3"></div>
    
    <hr class="my-5 border-secondary">
    
    <h3 class="mb-4">Liste des navires</h3>
    <div class="form-group position-relative" style="max-width:400px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par MMSI ou nom..." autocomplete="off">
      <div id="searchSuggestions" class="list-group position-absolute w-100" style="z-index:1000"></div>
    </div>
    <!-- Modal édition bateau -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Modifier le navire</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="editForm">
            <div class="modal-body">
              <input type="hidden" id="edit-MMSI" name="MMSI">
              <div class="form-group"><label>MMSI</label><input id="edit-MMSI-view" class="form-control" disabled></div>
              <div class="form-group"><label>IMO</label><input id="edit-IMO" name="IMO" class="form-control"></div>
              <div class="form-group"><label>CallSign</label><input id="edit-CallSign" name="CallSign" class="form-control"></div>
              <div class="form-group"><label>Nom</label><input id="edit-VesselName" name="VesselName" class="form-control"></div>
              <div class="form-group"><label>Type</label><input id="edit-VesselType" name="VesselType" class="form-control"></div>
              <div class="form-group"><label>Longueur</label><input id="edit-Length" name="Length" class="form-control"></div>
              <div class="form-group"><label>Largeur</label><input id="edit-Width" name="Width" class="form-control"></div>
              <div class="form-group"><label>Draft</label><input id="edit-Draft" name="Draft" class="form-control"></div>
              <div class="form-group"><label>Cargo</label><input id="edit-Cargo" name="Cargo" class="form-control"></div>
              <div class="form-group"><label>Classe</label><input id="edit-TransceiverClass" name="TransceiverClass" class="form-control"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-success">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <table class="table table-bordered table-hover" id="table-bateaux">
      <thead class="thead-dark">
        <tr>
          <th>MMSI</th>
          <th>IMO</th>
          <th>CallSign</th>
          <th>Nom</th>
          <th>Type</th>
          <th>Longueur</th>
          <th>Largeur</th>
          <th>Draft</th>
          <th>Cargo</th>
          <th>Classe</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <a href="index.html" class="btn btn-secondary ml-2">Retour à l'accueil</a>
  </div>
  <!-- Scripts JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  
  <!-- Scripts d'authentification -->
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/config.js"></script>
  
  <!-- Scripts spécifiques à la page admin -->
  <script src="assets/js/admin.js"></script>
  <script src="assets/js/clusters.js"></script>
  <script>
    // Fonction d'initialisation des fonctionnalités spécifiques à la page admin
    function initializeAdminFeatures() {
      console.log('Fonctionnalités admin initialisées');
      
      // Surcharger la fonction updateUIForAuthenticatedUser pour personnaliser le logo
      const originalUpdateUI = window.updateUIForAuthenticatedUser;
      window.updateUIForAuthenticatedUser = function(user) {
        // Appeler l'implémentation originale
        if (originalUpdateUI) originalUpdateUI(user);
        
        // Personnalisation supplémentaire pour la page admin
        const logoLink = document.querySelector('.navbar-brand');
        if (logoLink) {
          logoLink.innerHTML = `
            <img src="assets/img/cargo.png" alt="Logo AIS" style="height:40px;width:auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);background:#fff;padding:2px;">
            <span style="font-weight:bold;letter-spacing:1px;color:#28a745;">AIS&nbsp;Admin</span>`;
        }
      };
    }

    // Fonction pour initialiser le formulaire d'ajout de navire
    function initShipForm() {
      const shipForm = document.getElementById('shipForm');
      if (!shipForm) return;

      // Validation en temps réel
      const inputs = shipForm.querySelectorAll('[required]');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          if (this.checkValidity()) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
          }
        });
      });

      // Gestion de la soumission du formulaire
      shipForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Vérification de la validité du formulaire
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        // Désactiver le bouton pendant l'envoi
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Traitement...';
        
        try {
          const formData = new FormData(this);
          const data = Object.fromEntries(formData.entries());
          
          // Envoi de la requête sans authentification obligatoire
          const response = await fetch('api/boats.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Afficher un message de succès
            const messageDiv = document.getElementById('addShipMessage');
            messageDiv.innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                Navire ajouté avec succès !
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            `;
            
            // Réinitialiser le formulaire
            this.reset();
            this.classList.remove('was-validated');
            
            // Recharger la liste des navires
            if (window.loadVessels) {
              loadVessels();
            }
          } else {
            throw new Error(result.message || 'Erreur lors de l\'ajout du navire');
          }
        } catch (error) {
          console.error('Erreur:', error);
          const messageDiv = document.getElementById('addShipMessage');
          messageDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              ${error.message || 'Une erreur est survenue lors de l\'ajout du navire'}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          `;
        } finally {
          // Réactiver le bouton
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        }
      });
    }

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Vérifier si l'utilisateur est connecté
        const user = await checkAuth();
        if (user) {
          // Mettre à jour le titre de la page
          document.title = 'Tableau de bord - ' + user.username;
          
          // Initialiser les tooltips Bootstrap
          $('[data-toggle="tooltip"]').tooltip();
          
          // Initialiser les fonctionnalités spécifiques à la page admin
          initializeAdminFeatures();
          
          // Initialiser le formulaire
          initShipForm();
        }
      } catch (error) {
        console.error('Erreur d\'initialisation:', error);
      }
    });
  </script>
  
  <!-- Scripts spécifiques à la page admin -->
  <script src="assets/js/admin.js"></script>
  
  <!-- Gestionnaire d'erreur pour les requêtes AJAX non authentifiées -->
  <script>
    $(document).ajaxError(function(event, jqXHR) {
      if (jqXHR.status === 401) {
        // Non autorisé - rediriger vers la page de connexion
        window.location.href = 'login.html?session_expired=1';
      }
    });
  </script>


  <!-- Template Footer -->
  <div id="template-footer">
    <!-- Le contenu du footer sera chargé dynamiquement -->
  </div>



  <!-- Scripts communs -->
  
  
  



  <!-- Template Footer -->
  <div id="template-footer">
    <!-- Le contenu du footer sera chargé dynamiquement -->
  </div>



  <!-- Scripts communs -->
  
  
  



  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  
  
  


  <!-- Scripts communs -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/loadTemplates.js"></script>
  <script src="assets/js/auth.js"></script>
</body>
</html>
